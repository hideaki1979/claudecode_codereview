name: PR Analysis & Auto Labeling

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  analyze-and-label:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Analyze PR and Apply Labels
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: node .github/scripts/analyze-and-label.js

      - name: Comment Analysis Results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const analysisFile = '.github/analysis-result.json';

            if (fs.existsSync(analysisFile)) {
              const analysis = JSON.parse(fs.readFileSync(analysisFile, 'utf8'));

              let comment = '## ğŸ“Š PRåˆ†æçµæœ\n\n';

              // ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«
              const riskEmoji = {
                low: 'ğŸŸ¢',
                medium: 'ğŸŸ¡',
                high: 'ğŸ”´',
                critical: 'ğŸš¨'
              };
              comment += `### ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«: ${riskEmoji[analysis.risk.risk_level]} ${analysis.risk.risk_level.toUpperCase()}\n\n`;

              // ãƒ¡ãƒˆãƒªã‚¯ã‚¹
              comment += '### ãƒ¡ãƒˆãƒªã‚¯ã‚¹\n';
              comment += `- **è¤‡é›‘åº¦ã‚¹ã‚³ã‚¢**: ${analysis.complexity.complexity_score}/100 (${analysis.complexity.complexity_level})\n`;
              comment += `- **ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢**: ${analysis.risk.risk_score}/100\n`;
              comment += `- **å¤‰æ›´è¡Œæ•°**: ${analysis.complexity.lines_changed}è¡Œ\n`;
              comment += `- **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: ${analysis.complexity.files_changed}ãƒ•ã‚¡ã‚¤ãƒ«\n\n`;

              // æ¨å¥¨äº‹é …
              if (analysis.risk.recommendations.length > 0) {
                comment += '### ğŸ“ æ¨å¥¨äº‹é …\n';
                analysis.risk.recommendations.forEach(rec => {
                  comment += `- ${rec}\n`;
                });
              }

              comment += '\n---\n';
              comment += '*ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ by [Code Review Dashboard](https://github.com/hideaki1979/claudecode_codereview)*';

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
